"""
ë‹¤ë‹¨ê³„ ë¶„ì„ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤
ê° ì—ì´ì „íŠ¸ë³„ë¡œ ì´ˆê¸° ë° í›„ì† í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
"""

import json
from prompt_optimizer import (
    create_optimized_task_suggestion_prompt,
    create_optimized_progress_prompt,
    create_initial_completion_prompt,
    create_followup_completion_prompt,
    create_task_assignment_prompt
)

def create_task_suggestion_initial_prompt(context, user_message, read_files, analyzed_commits):
    """Task ì œì•ˆ ì—ì´ì „íŠ¸ ì´ˆê¸° í”„ë¡¬í”„íŠ¸"""
    commits = context.get('commits', [])
    issues = context.get('issues', [])
    currentTasks = context.get('currentTasks', [])
    projectDescription = context.get('projectDescription', '')
    githubRepo = context.get('githubRepo', '')
    
    # ì½ì€ íŒŒì¼ ì •ë³´ ì¶”ê°€
    files_context = ""
    if read_files:
        files_context = "\n\n## ì½ì€ íŒŒì¼ ë‚´ìš©:\n"
        for file_info in read_files[:5]:
            content = file_info.get('content', '')[:500]  # ìµœëŒ€ 500ì
            files_context += f"íŒŒì¼: {file_info.get('path', '')}\n{content}\n---\n"
    
    base_prompt = create_optimized_task_suggestion_prompt(
        commits, issues, currentTasks, projectDescription, githubRepo
    )
    
    return base_prompt + files_context + "\n\nìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ Taskë¥¼ ì œì•ˆí•˜ì„¸ìš”. JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”."

def create_task_suggestion_followup_prompt(context, previous_result, user_message, read_files, analyzed_commits):
    """Task ì œì•ˆ ì—ì´ì „íŠ¸ í›„ì† í”„ë¡¬í”„íŠ¸"""
    commits = context.get('commits', [])
    issues = context.get('issues', [])
    currentTasks = context.get('currentTasks', [])
    projectDescription = context.get('projectDescription', '')
    githubRepo = context.get('githubRepo', '')
    
    # ì½ì€ íŒŒì¼ ì •ë³´ ì¶”ê°€
    files_context = ""
    if read_files:
        files_context = "\n\n## ìƒˆë¡œ ì½ì€ íŒŒì¼ ë‚´ìš©:\n"
        for file_info in read_files[-5:]:  # ìµœê·¼ 5ê°œë§Œ
            content = file_info.get('content', '')[:500]
            files_context += f"íŒŒì¼: {file_info.get('path', '')}\n{content}\n---\n"
    
    prompt = f"""ì´ì „ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë” ê¹Šì´ ë¶„ì„í•˜ì„¸ìš”.

## ì´ì „ ë¶„ì„ ê²°ê³¼:
{json.dumps(previous_result, ensure_ascii=False, indent=2)[:1000]}

## í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:
- ì»¤ë°‹: {len(commits)}ê°œ
- ì´ìŠˆ: {len(issues)}ê°œ
- í˜„ì¬ Task: {len(currentTasks)}ê°œ
- í”„ë¡œì íŠ¸ ì„¤ëª…: {projectDescription[:200]}

{files_context}

## ì¶”ê°€ ë¶„ì„ ìš”ì²­:
ìœ„ íŒŒì¼ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ë” ì •í™•í•˜ê³  êµ¬ì²´ì ì¸ Taskë¥¼ ì œì•ˆí•˜ì„¸ìš”. 
íŠ¹íˆ ì½”ë“œ êµ¬ì¡°, íŒ¨í„´, ì ì¬ì  ë¬¸ì œì ì„ ë¶„ì„í•˜ì—¬ Taskë¥¼ ì œì•ˆí•˜ì„¸ìš”.

ë‹¤ìŒ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
[{{"title": "...", "description": "...", "category": "feature|refactor|security|performance|maintenance", "priority": "High|Medium|Low", "estimatedHours": ìˆ«ì, "reason": "..."}}]
"""
    return prompt

def create_progress_analysis_initial_prompt(context, user_message, read_files, analyzed_commits, step_number=1):
    """ì§„í–‰ë„ ë¶„ì„ ì—ì´ì „íŠ¸ ì´ˆê¸° í”„ë¡¬í”„íŠ¸ (1ë‹¨ê³„: í”„ë¡œì íŠ¸ ë¶„ì„)"""
    commits = context.get('commits', [])
    tasks = context.get('tasks', [])
    projectDescription = context.get('projectDescription', '')
    projectStartDate = context.get('projectStartDate', None)
    projectDueDate = context.get('projectDueDate', None)
    
    # ì½ì€ íŒŒì¼ ë‚´ìš© ì¶”ê°€
    files_section = ""
    if read_files:
        files_section = "\n\n## ğŸ“„ ì½ì€ íŒŒì¼ ë‚´ìš©:\n\n"
        for file_info in read_files:
            file_path = file_info.get('path', '')
            file_content = file_info.get('content', '')
            if file_content:
                content_preview = file_content[:3000] if len(file_content) > 3000 else file_content
                files_section += f"### íŒŒì¼: {file_path}\n```\n{content_preview}\n```\n\n"
    
    prompt = f"""ì§„í–‰ë„ ë¶„ì„ì„ ë‹¨ê³„ë³„ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤. í˜„ì¬ëŠ” **1ë‹¨ê³„: í”„ë¡œì íŠ¸ ë¶„ì„**ì…ë‹ˆë‹¤.

## í”„ë¡œì íŠ¸ ì •ë³´:
- í”„ë¡œì íŠ¸ ì„¤ëª…: {projectDescription[:200] if projectDescription else 'ì—†ìŒ'}
- í”„ë¡œì íŠ¸ ì‹œì‘ì¼: {projectStartDate or 'ë¯¸ì •'}
- í”„ë¡œì íŠ¸ ë§ˆê°ì¼: {projectDueDate or 'ë¯¸ì •'}
- ì´ ì»¤ë°‹ ìˆ˜: {len(commits)}ê°œ
- ì´ Task ìˆ˜: {len(tasks)}ê°œ
{files_section}

## 1ë‹¨ê³„ ì‘ì—…: í”„ë¡œì íŠ¸ ë¶„ì„ ë° í•µì‹¬ ê¸°ëŠ¥ ì •ì˜
ì½ì€ íŒŒì¼(README, ì„¤ì • íŒŒì¼ ë“±)ê³¼ í”„ë¡œì íŠ¸ ì„¤ëª…ì„ ë°”íƒ•ìœ¼ë¡œ **ì „ì²´ì ì¸ ì½”ë“œë‚˜ ë¬¸ì„œë¥¼ ì ê²€**í•˜ì—¬ ë‹¤ìŒì„ ì‘ì„±í•˜ì„¸ìš”:

**âš ï¸ ë§¤ìš° ì¤‘ìš”: íŒë‹¨ ê³¼ì •ì„ ë‹¨ê³„ë³„ë¡œ ëª…í™•íˆ ìˆ˜í–‰í•˜ì„¸ìš”.**

### 1ë‹¨ê³„: ì „ì²´ ë¬¸ì„œ/ì½”ë“œ ì ê²€
- README, package.json, í”„ë¡œì íŠ¸ ì„¤ëª… ë“±ì„ ì½ì–´ì„œ í”„ë¡œì íŠ¸ì˜ **í•µì‹¬ ê¸°ëŠ¥**ì„ íŒŒì•…í•˜ì„¸ìš”.
- **í•µì‹¬ ê¸°ëŠ¥ ì •ì˜ ê¸°ì¤€ (ì—„ê²©í•˜ê²Œ ì ìš©):**
  - âœ… **í¬í•¨í•´ì•¼ í•  ê¸°ëŠ¥**: ì‚¬ìš©ìì—ê²Œ ì§ì ‘ ì œê³µë˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°ëŠ¥ë§Œ í¬í•¨
    - ì˜ˆ: ì‚¬ìš©ì ì¸ì¦, í”„ë¡œì íŠ¸ ê´€ë¦¬, Task ê´€ë¦¬, AI ê¸°ëŠ¥, GitHub ì—°ë™ ë“±
  - âŒ **ì œì™¸í•´ì•¼ í•  ê¸°ëŠ¥**: 
    - ì¸í”„ë¼ ê¸°ëŠ¥ (ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, JWT ë¯¸ë“¤ì›¨ì–´, CORS ì„¤ì • ë“±)
    - ì§„í–‰ë„ ì¡°íšŒ (ê¸°ëŠ¥ì´ ì•„ë‹Œ ë©”íŠ¸ë¦­/ë¶„ì„ ë„êµ¬)
    - ê¸°íƒ€ ì§€ì› ê¸°ëŠ¥ (ë¡œê¹…, ì—ëŸ¬ í•¸ë“¤ë§ ë“±)
- í•µì‹¬ ê¸°ëŠ¥ì€ í”„ë¡œì íŠ¸ì˜ ëª©ì ì„ ë‹¬ì„±í•˜ê¸° ìœ„í•´ **ì‚¬ìš©ìê°€ ì§ì ‘ ì‚¬ìš©í•˜ëŠ”** ì£¼ìš” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### 2ë‹¨ê³„: í•µì‹¬ ê¸°ëŠ¥ ì •ì˜ ë° ì¤‘ìš”ë„ ë¶€ì—¬
- íŒŒì•…í•œ í•µì‹¬ ê¸°ëŠ¥ë“¤ì„ ë‚˜ì—´í•˜ì„¸ìš”.
- **í•µì‹¬ ê¸°ëŠ¥ ê°œìˆ˜ ì œí•œ: 3-6ê°œ** (ë„ˆë¬´ ë§ê±°ë‚˜ ì ì§€ ì•Šê²Œ)
- ê° í•µì‹¬ ê¸°ëŠ¥ì— ëŒ€í•´ ê°„ë‹¨í•œ ì„¤ëª…ê³¼ ì¤‘ìš”ë„(weight)ë¥¼ ë¶€ì—¬í•˜ì„¸ìš”.
- **ì¤‘ìš”ë„ ê¸°ì¤€:**
  - weight 1.0: í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°ëŠ¥ (ëª¨ë“  í•µì‹¬ ê¸°ëŠ¥ì€ 1.0ìœ¼ë¡œ ì„¤ì •)
  - weight 0.5 ì´í•˜: í•µì‹¬ ê¸°ëŠ¥ì´ ì•„ë‹˜ (ì œì™¸)
- **ì¸í”„ë¼ ê´€ë ¨ ê¸°ëŠ¥ì€ ì ˆëŒ€ í•µì‹¬ ê¸°ëŠ¥ìœ¼ë¡œ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.**

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{{
  "step": 1,
  "projectName": "ì‹¤ì œ í”„ë¡œì íŠ¸ ì´ë¦„ (READMEë‚˜ package.jsonì—ì„œ í™•ì¸í•œ ì‹¤ì œ ì´ë¦„, [í”„ë¡œì íŠ¸ì˜ ì‹¤ì œ ì´ë¦„] ê°™ì€ í˜•ì‹ì´ ì•„ë‹Œ ì‹¤ì œ ê°’)",
  "projectDescription": "ì‹¤ì œ í”„ë¡œì íŠ¸ ì„¤ëª… (ì´ í”„ë¡œì íŠ¸ëŠ” ì–´ë–¤ í”„ë¡œì íŠ¸ì¸ì§€, í•µì‹¬ ê¸°ëŠ¥ê³¼ ì£¼ìš” ê¸°ëŠ¥ë“¤ì„ ì„¤ëª…. ê¸°ìˆ  ìŠ¤íƒì€ ìƒëµí•˜ê³  ê¸°ëŠ¥ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±. [ì´ í”„ë¡œì íŠ¸ëŠ”...] ê°™ì€ í˜•ì‹ì´ ì•„ë‹Œ ì‹¤ì œ ì„¤ëª…)",
  "coreFeatures": [
    {{
      "id": "core_feature_1",
      "name": "í•µì‹¬ ê¸°ëŠ¥ëª… (ì˜ˆ: ì‚¬ìš©ì ì¸ì¦, í”„ë¡œì íŠ¸ ê´€ë¦¬, Task ê´€ë¦¬, AI ê¸°ëŠ¥ ë“±)",
      "description": "ì´ í•µì‹¬ ê¸°ëŠ¥ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª… (1-2ë¬¸ì¥)",
      "weight": 1.0
    }},
    {{
      "id": "core_feature_2",
      "name": "ë‹¤ë¥¸ í•µì‹¬ ê¸°ëŠ¥ëª…",
      "description": "ì„¤ëª…",
      "weight": 1.0
    }}
  ],
  "nextStep": "ë‹¤ìŒ ë‹¨ê³„(2ë‹¨ê³„)ì—ì„œëŠ” ê° í•µì‹¬ ê¸°ëŠ¥ì— í•„ìš”í•œ ì„¸ë¶€ ê¸°ëŠ¥ë“¤ì„ ë¶„ì„í•˜ê² ìŠµë‹ˆë‹¤."
}}

âš ï¸ **ë§¤ìš° ì¤‘ìš”**: 
- ì½ì€ íŒŒì¼ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í”„ë¡œì íŠ¸ê°€ ë¬´ì—‡ì¸ì§€ ì •í™•íˆ íŒŒì•…í•˜ì„¸ìš”.
- í”„ë¡œì íŠ¸ ì´ë¦„ì€ READMEë‚˜ package.jsonì—ì„œ í™•ì¸í•œ **ì‹¤ì œ ì´ë¦„**ì„ ì…ë ¥í•˜ì„¸ìš”. "[í”„ë¡œì íŠ¸ì˜ ì‹¤ì œ ì´ë¦„]" ê°™ì€ í˜•ì‹ì´ ì•„ë‹Œ ì‹¤ì œ ê°’ì…ë‹ˆë‹¤.
- í”„ë¡œì íŠ¸ ì„¤ëª…ì€ **ê¸°ëŠ¥ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±**í•˜ì„¸ìš”. ê¸°ìˆ  ìŠ¤íƒ(React, Node.js ë“±)ì€ ìƒëµí•˜ê³ , í•µì‹¬ ê¸°ëŠ¥ê³¼ ì£¼ìš” ê¸°ëŠ¥ë“¤ì„ ì„¤ëª…í•˜ì„¸ìš”.
- í˜•ì‹: "ì´ í”„ë¡œì íŠ¸ëŠ” [í•µì‹¬ ê¸°ëŠ¥]ì´ í•µì‹¬ ê¸°ëŠ¥ì´ê³ , [ì£¼ìš” ê¸°ëŠ¥ 1], [ì£¼ìš” ê¸°ëŠ¥ 2], [ì£¼ìš” ê¸°ëŠ¥ 3] ë“±ì˜ ê¸°ëŠ¥ì´ ìˆìŠµë‹ˆë‹¤."
- **í•µì‹¬ ê¸°ëŠ¥ì€ ë°˜ë“œì‹œ 3-6ê°œë¡œ ì •ì˜í•˜ì„¸ìš”.** (ë„ˆë¬´ ë§ê±°ë‚˜ ì ì§€ ì•Šê²Œ)
- **í•µì‹¬ ê¸°ëŠ¥ ì •ì˜ ê²€ì¦:**
  - âœ… ì‚¬ìš©ìì—ê²Œ ì§ì ‘ ì œê³µë˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°ëŠ¥ì¸ê°€?
  - âŒ ì¸í”„ë¼ ê¸°ëŠ¥(DB ì—°ê²°, ë¯¸ë“¤ì›¨ì–´ ë“±)ì¸ê°€? â†’ ì œì™¸
  - âŒ ì§„í–‰ë„ ì¡°íšŒ ê°™ì€ ë©”íŠ¸ë¦­/ë¶„ì„ ë„êµ¬ì¸ê°€? â†’ ì œì™¸
  - âŒ ì¤‘ìš”ë„ê°€ ë‚®ì€ ê¸°ëŠ¥(í”„ë¡œí•„ ë³€ê²½ ë“±)ì¸ê°€? â†’ ì œì™¸
- **ëª¨ë“  í•µì‹¬ ê¸°ëŠ¥ì˜ weightëŠ” 1.0ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.** (weight 0.5 ì´í•˜ëŠ” í•µì‹¬ ê¸°ëŠ¥ì´ ì•„ë‹˜)
- ì˜ˆì‹œ: projectName: "To-do-ai-agent" (ì‹¤ì œ ê°’), projectDescription: "ì´ í”„ë¡œì íŠ¸ëŠ” AI Agentê°€ í•µì‹¬ ê¸°ëŠ¥ì´ê³ , ì§„í–‰ë„ ë¶„ì„, Task ì œì•ˆ, Task ì™„ë£Œ í™•ì¸ ë“±ì˜ ê¸°ëŠ¥ì´ ìˆìŠµë‹ˆë‹¤." (ê¸°ëŠ¥ ì¤‘ì‹¬ ì„¤ëª…)
- coreFeatures ì˜ˆì‹œ: [{{id: "auth", name: "ì‚¬ìš©ì ì¸ì¦", description: "ë¡œê·¸ì¸, íšŒì›ê°€ì…, ë¡œê·¸ì•„ì›ƒ ë“± ì‚¬ìš©ì ì¸ì¦ ê¸°ëŠ¥", weight: 1.0}}, {{id: "project", name: "í”„ë¡œì íŠ¸ ê´€ë¦¬", description: "í”„ë¡œì íŠ¸ ìƒì„±, ìˆ˜ì •, ì‚­ì œ, ì¡°íšŒ ë“± í”„ë¡œì íŠ¸ ê´€ë¦¬ ê¸°ëŠ¥", weight: 1.0}}, {{id: "task", name: "Task ê´€ë¦¬", description: "Task ìƒì„±, ìˆ˜ì •, ì‚­ì œ, ì¡°íšŒ ë“± Task ê´€ë¦¬ ê¸°ëŠ¥", weight: 1.0}}, {{id: "ai", name: "AI ê¸°ëŠ¥", description: "ì§„í–‰ë„ ë¶„ì„, Task ì œì•ˆ, Task ì™„ë£Œ í™•ì¸ ë“± AI ê¸°ëŠ¥", weight: 1.0}}, {{id: "github", name: "GitHub ì—°ë™", description: "GitHub ì €ì¥ì†Œ ì—°ë™ ë° ì»¤ë°‹/ì´ìŠˆ ì¡°íšŒ ê¸°ëŠ¥", weight: 1.0}}]"""
    
    return prompt

def create_progress_analysis_followup_prompt(context, previous_result, user_message, read_files, analyzed_commits, step_number, all_steps):
    """ì§„í–‰ë„ ë¶„ì„ ì—ì´ì „íŠ¸ í›„ì† í”„ë¡¬í”„íŠ¸ (ë‹¨ê³„ë³„)"""
    commits = context.get('commits', [])
    tasks = context.get('tasks', [])
    
    # ì´ì „ ë‹¨ê³„ë“¤ì˜ ê²°ê³¼ ìˆ˜ì§‘
    step1_result = all_steps[0] if len(all_steps) > 0 else {}
    step2_result = all_steps[1] if len(all_steps) > 1 else {}
    step3_result = all_steps[2] if len(all_steps) > 2 else {}
    step4_result = all_steps[3] if len(all_steps) > 3 else {}
    
    # ì½ì€ íŒŒì¼ ë‚´ìš©
    files_section = ""
    if read_files:
        files_section = "\n\n## ğŸ“„ ì½ì€ íŒŒì¼ ë‚´ìš©:\n\n"
        for f in read_files[-10:]:  # ìµœê·¼ 10ê°œ íŒŒì¼
            path = f.get('path', '')
            content = f.get('content', '')
            if content:
                content_preview = content[:2000] if len(content) > 2000 else content
                files_section += f"### íŒŒì¼: {path}\n```\n{content_preview}\n```\n\n"
    
    if step_number == 2:
        # 2ë‹¨ê³„: ê¸°ëŠ¥ ë¶„ì„ (ê° í•µì‹¬ ê¸°ëŠ¥ì— í•„ìš”í•œ ì„¸ë¶€ ê¸°ëŠ¥ë“¤ íŒŒì•…)
        core_features = step1_result.get('coreFeatures', [])
        core_features_text = "\n".join([f"- {f.get('name', '')} ({f.get('description', '')})" for f in core_features])
        
        prompt = f"""ì§„í–‰ë„ ë¶„ì„ **2ë‹¨ê³„: ì„¸ë¶€ ê¸°ëŠ¥ ë¶„ì„**ì…ë‹ˆë‹¤.

## ì´ì „ ë‹¨ê³„(1ë‹¨ê³„) ê²°ê³¼:
í”„ë¡œì íŠ¸ ì´ë¦„: {step1_result.get('projectName', 'N/A')}
í”„ë¡œì íŠ¸ ì„¤ëª…: {step1_result.get('projectDescription', 'N/A')[:200]}...

### í•µì‹¬ ê¸°ëŠ¥ ëª©ë¡:
{core_features_text}

{files_section}

## 2ë‹¨ê³„ ì‘ì—…: ê° í•µì‹¬ ê¸°ëŠ¥ë³„ ì„¸ë¶€ ê¸°ëŠ¥ ë¶„ì„
ì´ì „ ë‹¨ê³„ì—ì„œ ì •ì˜í•œ **ê° í•µì‹¬ ê¸°ëŠ¥**ì— ëŒ€í•´, ê·¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ í•„ìš”í•œ **ì„¸ë¶€ ê¸°ëŠ¥ë“¤**ì„ ë‚˜ì—´í•˜ì„¸ìš”.

**âš ï¸ ë§¤ìš° ì¤‘ìš”: íŒë‹¨ ê³¼ì •ì„ ë‹¨ê³„ë³„ë¡œ ëª…í™•íˆ ìˆ˜í–‰í•˜ì„¸ìš”.**

### 1ë‹¨ê³„: í•µì‹¬ ê¸°ëŠ¥ë³„ ì„¸ë¶€ ê¸°ëŠ¥ íŒŒì•…
- ê° í•µì‹¬ ê¸°ëŠ¥ì— ëŒ€í•´, ê·¸ ê¸°ëŠ¥ì„ ì™„ì „íˆ êµ¬í˜„í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ì„¸ë¶€ ê¸°ëŠ¥ë“¤ì„ ìƒê°í•´ë³´ì„¸ìš”.
- ì˜ˆ: "ì‚¬ìš©ì ì¸ì¦" í•µì‹¬ ê¸°ëŠ¥ì˜ ê²½ìš° â†’ ë¡œê·¸ì¸ í˜ì´ì§€, íšŒì›ê°€ì… í˜ì´ì§€, ë¡œê·¸ì¸ API, íšŒì›ê°€ì… API, ë¡œê·¸ì•„ì›ƒ API, JWT ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ë“±

### 2ë‹¨ê³„: ì„¸ë¶€ ê¸°ëŠ¥ ë¶„ë¥˜
- ê° ì„¸ë¶€ ê¸°ëŠ¥ì„ **í˜ì´ì§€, API, ì»´í¬ë„ŒíŠ¸, ì¸í”„ë¼** 4ê°€ì§€ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”.

**ê¸°ëŠ¥ ë¶„ë¥˜ (ë°˜ë“œì‹œ ë‹¤ìŒ 5ê°€ì§€ë¡œ ë¶„ë¥˜):**
- **í˜ì´ì§€**: ê° í˜ì´ì§€ ê²½ë¡œ (ì˜ˆ: ë¡œê·¸ì¸ í˜ì´ì§€, í”„ë¡œì íŠ¸ ëª©ë¡ í˜ì´ì§€, AI ì–´ë“œë°”ì´ì € í˜ì´ì§€ ë“±)
- **API**: í¬ê´„ì ì¸ API ê·¸ë£¹ (ì˜ˆ: ì‚¬ìš©ì ì¸ì¦ API, í”„ë¡œì íŠ¸ ê´€ë¦¬ API, Task ê´€ë¦¬ API, GitHub ì—°ë™ API, AI API ë“±)
- **ì»´í¬ë„ŒíŠ¸**: ì¬ì‚¬ìš© ê°€ëŠ¥í•œ UI ì»´í¬ë„ŒíŠ¸ (ì˜ˆ: Task ì¹´ë“œ ì»´í¬ë„ŒíŠ¸, í”„ë¡œì íŠ¸ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸, GitHub ì»¤ë°‹ ë¦¬ìŠ¤íŠ¸ ì»´í¬ë„ŒíŠ¸ ë“±)
- **ì¸í”„ë¼**: ì¸í”„ë¼ ë° ë°±ì—”ë“œ ê¸°ëŠ¥ (ì˜ˆ: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, JWT ì¸ì¦ ë¯¸ë“¤ì›¨ì–´, íŒŒì¼ ì—…ë¡œë“œ, CORS ì„¤ì • ë“±)
- **í…ŒìŠ¤íŠ¸/ë°°í¬**: í…ŒìŠ¤íŠ¸ ë° ë°°í¬ ê´€ë ¨ ê¸°ëŠ¥ (ì˜ˆ: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, í†µí•© í…ŒìŠ¤íŠ¸, E2E í…ŒìŠ¤íŠ¸, CI/CD íŒŒì´í”„ë¼ì¸, ë°°í¬ ìŠ¤í¬ë¦½íŠ¸, Docker ì„¤ì • ë“±)
  - **ì¤‘ìš”**: í”„ë¡œì íŠ¸ íŠ¹ì„±ì— ë”°ë¼ í…ŒìŠ¤íŠ¸/ë°°í¬ê°€ í•„ìš”í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - **ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜**: í…ŒìŠ¤íŠ¸(ë‹¨ìœ„/í†µí•©/E2E), CI/CD, ë°°í¬ ì„¤ì • ë“±
  - **API ì„œë²„**: í…ŒìŠ¤íŠ¸(ë‹¨ìœ„/í†µí•©), CI/CD, ë°°í¬ ì„¤ì • ë“±
  - **ë¼ì´ë¸ŒëŸ¬ë¦¬**: í…ŒìŠ¤íŠ¸(ë‹¨ìœ„), CI/CD ë“±
  - **ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸/ë„êµ¬**: í…ŒìŠ¤íŠ¸/ë°°í¬ê°€ í•„ìš” ì—†ì„ ìˆ˜ ìˆìŒ (ë¹„ìœ¨ 0%)

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{{
  "step": 2,
  "requiredFeatures": [
    {{
      "coreFeatureId": "core_feature_1",
      "coreFeatureName": "í•µì‹¬ ê¸°ëŠ¥ëª…",
      "name": "ì„¸ë¶€ ê¸°ëŠ¥ëª… (ì˜ˆ: ë¡œê·¸ì¸ í˜ì´ì§€, ì‚¬ìš©ì ì¸ì¦ API, í”„ë¡œì íŠ¸ ê´€ë¦¬ API, ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, CI/CD íŒŒì´í”„ë¼ì¸ ë“±)",
      "type": "page|api|component|infrastructure|test_deployment",
      "description": "ê°„ë‹¨í•œ ì„¤ëª… (1-2ë¬¸ì¥)",
      "expectedLocation": "ì˜ˆìƒ ìœ„ì¹˜ (í˜ì´ì§€: ê²½ë¡œ, API: ì—”ë“œí¬ì¸íŠ¸ ê·¸ë£¹, í…ŒìŠ¤íŠ¸/ë°°í¬: í…ŒìŠ¤íŠ¸ íŒŒì¼ ê²½ë¡œ ë˜ëŠ” ë°°í¬ ì„¤ì • íŒŒì¼)"
    }}
  ],
  "nextStep": "ë‹¤ìŒ ë‹¨ê³„(3ë‹¨ê³„)ì—ì„œëŠ” ì†ŒìŠ¤ì½”ë“œë¥¼ í™•ì¸í•˜ì—¬ ì‹¤ì œë¡œ êµ¬í˜„ëœ ê¸°ëŠ¥ì„ ì°¾ê² ìŠµë‹ˆë‹¤."
}}

âš ï¸ **ë§¤ìš° ì¤‘ìš”**: 
- **1ë‹¨ê³„ ê²€ì¦**: í•µì‹¬ ê¸°ëŠ¥ì´ 3-6ê°œì´ê³ , ì¸í”„ë¼ê°€ í¬í•¨ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
- **ê° í•µì‹¬ ê¸°ëŠ¥ë³„ë¡œ** í•„ìš”í•œ ì„¸ë¶€ ê¸°ëŠ¥ë“¤ì„ ë‚˜ì—´í•˜ì„¸ìš”.
- ê° ì„¸ë¶€ ê¸°ëŠ¥ì€ ë°˜ë“œì‹œ **coreFeatureId**ì™€ **coreFeatureName**ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
- ë°˜ë“œì‹œ **í˜ì´ì§€, API, ì»´í¬ë„ŒíŠ¸, ì¸í”„ë¼, í…ŒìŠ¤íŠ¸/ë°°í¬** 5ê°€ì§€ ë¶„ë¥˜ë¡œ ë‚˜ëˆ„ì–´ ë‚˜ì—´í•˜ì„¸ìš”.
- **í•µì‹¬ ê¸°ëŠ¥ì— ì†í•˜ëŠ” ì„¸ë¶€ ê¸°ëŠ¥**: í˜ì´ì§€, API, ì»´í¬ë„ŒíŠ¸ë§Œ í¬í•¨í•˜ì„¸ìš”.
- **ì¸í”„ë¼ ê¸°ëŠ¥**: í•µì‹¬ ê¸°ëŠ¥ì— ì†í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë³„ë„ë¡œ ë‚˜ì—´í•˜ì„¸ìš” (coreFeatureId ì—†ì´).
- **í…ŒìŠ¤íŠ¸/ë°°í¬**: í”„ë¡œì íŠ¸ íŠ¹ì„±ì— ë”°ë¼ í…ŒìŠ¤íŠ¸/ë°°í¬ ê¸°ëŠ¥ì„ í¬í•¨í•˜ì„¸ìš”.
  - ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë‚˜ API ì„œë²„: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, í†µí•© í…ŒìŠ¤íŠ¸, E2E í…ŒìŠ¤íŠ¸, CI/CD íŒŒì´í”„ë¼ì¸, ë°°í¬ ì„¤ì • ë“±
  - ë¼ì´ë¸ŒëŸ¬ë¦¬: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, CI/CD ë“±
  - ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸: í…ŒìŠ¤íŠ¸/ë°°í¬ê°€ í•„ìš” ì—†ì„ ìˆ˜ ìˆìŒ
- ê° í•µì‹¬ ê¸°ëŠ¥ë‹¹ **3-8ê°œì˜ ì„¸ë¶€ ê¸°ëŠ¥**ì„ ë‚˜ì—´í•˜ì„¸ìš”. (ë„ˆë¬´ ë§ê±°ë‚˜ ì ì§€ ì•Šê²Œ)
- **í•µì‹¬ ê¸°ëŠ¥ì— ì†í•˜ì§€ ì•ŠëŠ” ì‚¬ì†Œí•œ ê¸°ëŠ¥(í”„ë¡œí•„ ë³€ê²½, ì„¤ì • í˜ì´ì§€ ë“±)ì€ ì œì™¸í•˜ì„¸ìš”.**
- **ê²€ì¦**: ê° í•µì‹¬ ê¸°ëŠ¥ë‹¹ ìµœì†Œ 3ê°œ ì´ìƒì˜ ì„¸ë¶€ ê¸°ëŠ¥ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."""
    
    elif step_number == 3:
        # 3ë‹¨ê³„: ì •ë³´ ì¶”ì¶œ (ì†ŒìŠ¤ì½”ë“œì—ì„œ êµ¬í˜„ëœ ê¸°ëŠ¥ í™•ì¸)
        required_features = step2_result.get('requiredFeatures', [])
        required_features_text = "\n".join([f"- {f.get('name', '')} ({f.get('type', 'unknown')})" for f in required_features[:15]])
        
        prompt = f"""ì§„í–‰ë„ ë¶„ì„ **3ë‹¨ê³„: êµ¬í˜„ëœ ê¸°ëŠ¥ í™•ì¸**ì…ë‹ˆë‹¤.

## ì´ì „ ë‹¨ê³„ ê²°ê³¼:

### 1ë‹¨ê³„: í”„ë¡œì íŠ¸ ë¶„ì„
í”„ë¡œì íŠ¸ ì´ë¦„: {step1_result.get('projectName', 'N/A')}

### 2ë‹¨ê³„: í•„ìš”í•œ ê¸°ëŠ¥ ë¶„ì„
í•„ìš”í•œ ê¸°ëŠ¥ ëª©ë¡:
{required_features_text}

{files_section}

## 3ë‹¨ê³„ ì‘ì—…: êµ¬í˜„ëœ ê¸°ëŠ¥ í™•ì¸ ë° í•µì‹¬ ê¸°ëŠ¥ë³„ ì§„í–‰ë„ ê³„ì‚°
ìœ„ì—ì„œ ì½ì€ íŒŒì¼ ë‚´ìš©ì„ **ë°˜ë“œì‹œ í™œìš©í•˜ì—¬** ì‹¤ì œ ì†ŒìŠ¤ì½”ë“œì—ì„œ í™•ì¸ëœ ê¸°ëŠ¥ì„ ì°¾ê³ , **ê° í•µì‹¬ ê¸°ëŠ¥ë³„ë¡œ ì§„í–‰ë„ë¥¼ ê³„ì‚°**í•˜ì„¸ìš”.

**âš ï¸ ë§¤ìš° ì¤‘ìš”: íŒë‹¨ ê³¼ì •ì„ ë‹¨ê³„ë³„ë¡œ ëª…í™•íˆ ìˆ˜í–‰í•˜ì„¸ìš”.**

### 1ë‹¨ê³„: 2ë‹¨ê³„ ê²°ê³¼ ê²€ì¦
- 2ë‹¨ê³„ì—ì„œ ì •ì˜í•œ **ëª¨ë“  {len(required_features)}ê°œ ê¸°ëŠ¥**ì„ í™•ì¸í–ˆëŠ”ì§€ ê²€ì¦í•˜ì„¸ìš”.
- ê° í•µì‹¬ ê¸°ëŠ¥ë³„ë¡œ í•„ìš”í•œ ì„¸ë¶€ ê¸°ëŠ¥ ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.
- ì½ì€ íŒŒì¼ ëª©ë¡ì„ í™•ì¸í•˜ì—¬ í•„ìš”í•œ íŒŒì¼ì„ ëª¨ë‘ ì½ì—ˆëŠ”ì§€ ê²€ì¦í•˜ì„¸ìš”.

### 2ë‹¨ê³„: íŒŒì¼ ë‚´ìš© ë¶„ì„
- ì½ì€ ê° íŒŒì¼ì˜ ë‚´ìš©ì„ **í•˜ë‚˜ì”© í™•ì¸**í•˜ì„¸ìš”.
- ê° íŒŒì¼ì—ì„œ ì–´ë–¤ ê¸°ëŠ¥ì´ êµ¬í˜„ë˜ì–´ ìˆëŠ”ì§€ **êµ¬ì²´ì ìœ¼ë¡œ íŒŒì•…**í•˜ì„¸ìš”.
- ì˜ˆ: routes/user.js íŒŒì¼ì„ ì½ì—ˆë‹¤ë©´, ê·¸ ì•ˆì˜ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸(/api/user/login, /api/user/register ë“±)ë¥¼ ì°¾ì•„ì„œ ë‚˜ì—´í•˜ì„¸ìš”.
- **2ë‹¨ê³„ì—ì„œ ì˜ˆìƒí•œ ìœ„ì¹˜ì˜ íŒŒì¼ì„ ìš°ì„ ì ìœ¼ë¡œ í™•ì¸**í•˜ì„¸ìš”.

### 3ë‹¨ê³„: ê¸°ëŠ¥ ë¶„ë¥˜ ë° í•µì‹¬ ê¸°ëŠ¥ ë§¤í•‘
- ì°¾ì€ ê¸°ëŠ¥ì„ **í˜ì´ì§€, API, ì»´í¬ë„ŒíŠ¸, ì¸í”„ë¼, í…ŒìŠ¤íŠ¸/ë°°í¬** 5ê°€ì§€ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”.
- ê° ê¸°ëŠ¥ì´ **ì–´ë–¤ í•µì‹¬ ê¸°ëŠ¥ì— ì†í•˜ëŠ”ì§€** ë§¤í•‘í•˜ì„¸ìš” (coreFeatureId ì‚¬ìš©).
- **2ë‹¨ê³„ì—ì„œ ì •ì˜í•œ requiredFeaturesì™€ ì¼ëŒ€ì¼ë¡œ ë§¤ì¹­**í•˜ì„¸ìš”.
- APIì˜ ê²½ìš°, ë¹„ìŠ·í•œ ì—”ë“œí¬ì¸íŠ¸ë¼ë¦¬ ë¬¶ì–´ì„œ ê·¸ë£¹í™”í•˜ì„¸ìš”.
- ì˜ˆ: /api/user/login, /api/user/register, /api/user/logout â†’ "ì‚¬ìš©ì ì¸ì¦ API" ê·¸ë£¹ â†’ coreFeatureId: "auth"
- **í…ŒìŠ¤íŠ¸/ë°°í¬**: í…ŒìŠ¤íŠ¸ íŒŒì¼(*.test.js, *.spec.js, __tests__/, tests/ ë“±)ì´ë‚˜ CI/CD ì„¤ì • íŒŒì¼(.github/workflows/, .gitlab-ci.yml, Dockerfile ë“±)ì„ í™•ì¸í•˜ì„¸ìš”.

### 4ë‹¨ê³„: í•µì‹¬ ê¸°ëŠ¥ë³„ ì§„í–‰ë„ ê³„ì‚°
- ê° í•µì‹¬ ê¸°ëŠ¥ì— ëŒ€í•´:
  - í•„ìš”í•œ ì„¸ë¶€ ê¸°ëŠ¥ ìˆ˜ (2ë‹¨ê³„ì—ì„œ ì •ì˜í•œ ê²ƒ) - **ì •í™•íˆ ì„¸ê¸°**
  - êµ¬í˜„ëœ ì„¸ë¶€ ê¸°ëŠ¥ ìˆ˜ (ì‹¤ì œë¡œ í™•ì¸ëœ ê²ƒ) - **ì •í™•íˆ ì„¸ê¸°**
  - ì§„í–‰ë„ = (êµ¬í˜„ëœ ì„¸ë¶€ ê¸°ëŠ¥ ìˆ˜ / í•„ìš”í•œ ì„¸ë¶€ ê¸°ëŠ¥ ìˆ˜) Ã— 100
- ì˜ˆ: "ì‚¬ìš©ì ì¸ì¦" í•µì‹¬ ê¸°ëŠ¥ì˜ ê²½ìš°
  - í•„ìš”í•œ ì„¸ë¶€ ê¸°ëŠ¥: 5ê°œ (ë¡œê·¸ì¸ í˜ì´ì§€, íšŒì›ê°€ì… í˜ì´ì§€, ë¡œê·¸ì¸ API, íšŒì›ê°€ì… API, ë¡œê·¸ì•„ì›ƒ API)
  - êµ¬í˜„ëœ ì„¸ë¶€ ê¸°ëŠ¥: 4ê°œ (ë¡œê·¸ì¸ í˜ì´ì§€, íšŒì›ê°€ì… í˜ì´ì§€, ë¡œê·¸ì¸ API, íšŒì›ê°€ì… API)
  - ì§„í–‰ë„: (4 / 5) Ã— 100 = 80%
- **ì¸í”„ë¼ ê¸°ëŠ¥ì€ í•µì‹¬ ê¸°ëŠ¥ì— í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.** (ë³„ë„ë¡œ ë‚˜ì—´)

**ì¤‘ìš”**: ì½ì€ íŒŒì¼ì—ì„œ **ê°€ëŠ¥í•œ ëŒ€ë¶€ë¶„ì˜ ê¸°ëŠ¥ì„ í™•ì¸**í•˜ì„¸ìš”. ì¼ë¶€ë§Œ í™•ì¸í•˜ì§€ ë§ê³  ëª¨ë“  ê¸°ëŠ¥ì„ ì°¾ì•„ë³´ì„¸ìš”.

**í”„ë¡œì íŠ¸ íŠ¹ì„±ì— ë”°ë¥¸ ìœ ë™ì  ì†Œì œëª© ë¶„ë¥˜:**
- í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë”°ë¼ ì†Œì œëª©ì„ ìœ ë™ì ìœ¼ë¡œ ë‚˜ëˆ„ì„¸ìš”.
- **ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜**: í˜ì´ì§€, API, ì»´í¬ë„ŒíŠ¸, ì¸í”„ë¼, í…ŒìŠ¤íŠ¸/ë°°í¬
- **API ì„œë²„**: ì—”ë“œí¬ì¸íŠ¸, ì„œë¹„ìŠ¤, ì¸í”„ë¼, í…ŒìŠ¤íŠ¸/ë°°í¬
- **ë¼ì´ë¸ŒëŸ¬ë¦¬**: ëª¨ë“ˆ, í•¨ìˆ˜, ìœ í‹¸ë¦¬í‹°, í…ŒìŠ¤íŠ¸
- **í”„ë¡œì íŠ¸ì— í˜ì´ì§€ë‚˜ ì»´í¬ë„ŒíŠ¸ê°€ ì—†ë‹¤ë©´**: í•´ë‹¹ ì†Œì œëª©ì„ ìƒëµí•˜ê³  ë‹¤ë¥¸ ì†Œì œëª©ì— ì§‘ì¤‘í•˜ì„¸ìš”.
- **í…ŒìŠ¤íŠ¸/ë°°í¬ê°€ ì—†ëŠ” í”„ë¡œì íŠ¸**: ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸ë‚˜ ë„êµ¬ì˜ ê²½ìš° í…ŒìŠ¤íŠ¸/ë°°í¬ ì†Œì œëª©ì„ ìƒëµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**í‘œì‹œ í˜•ì‹ (í”„ë¡œì íŠ¸ íŠ¹ì„±ì— ë”°ë¼ ìœ ë™ì ìœ¼ë¡œ ë¶„ë¥˜):**
- **í˜ì´ì§€** (ì›¹ ì•±ì¸ ê²½ìš°): `í˜ì´ì§€ëª… /ê²½ë¡œ/ê²½ë¡œ/.jsx` (ì˜ˆ: ë¡œê·¸ì¸ í˜ì´ì§€ /src/pages/Login.jsx)
  - ì½ì€ í˜ì´ì§€ íŒŒì¼ë“¤ì—ì„œ ê° í˜ì´ì§€ì˜ ì—­í• ê³¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.
  - í˜ì´ì§€ê°€ ì—†ë‹¤ë©´ ì´ ì†Œì œëª©ì„ ìƒëµí•˜ì„¸ìš”.
- **API**: ë¹„ìŠ·í•œ APIë¼ë¦¬ ë¬¶ì–´ì„œ ê·¸ë£¹í™”í•˜ì—¬ í‘œì‹œ
  - ì˜ˆ: **ì‚¬ìš©ì ì¸ì¦ API** /api/user/login, /api/user/logout, /api/user/register, /api/user/signup, /api/user/me
  - ì˜ˆ: **í”„ë¡œì íŠ¸ ê´€ë¦¬ API** /api/project/create, /api/project/update, /api/project/delete, /api/project/info, /api/project/list, /api/project/members
  - ì˜ˆ: **Task ê´€ë¦¬ API** /api/task/create, /api/task/update, /api/task/delete, /api/task/info, /api/task/assign, /api/task/status
  - ì˜ˆ: **GitHub ì—°ë™ API** /api/github/sync/:projectId, /api/github/commits/:projectId, /api/github/issues/:projectId, /api/github/branches/:projectId
  - ì˜ˆ: **AI API** /api/ai/chat, /api/ai/task-suggestion, /api/ai/progress-analysis, /api/ai/task-completion-check
  - ì˜ˆ: **ì§„í–‰ë„ ì¡°íšŒ API** /api/progress/project/:projectId
  - ì½ì€ ë¼ìš°íŠ¸ íŒŒì¼ë“¤ì—ì„œ **ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì•„ì„œ** ë¹„ìŠ·í•œ ê²ƒë¼ë¦¬ ë¬¶ì–´ì„œ ê·¸ë£¹í™”í•˜ì„¸ìš”.
- **ì»´í¬ë„ŒíŠ¸** (ì›¹ ì•±ì¸ ê²½ìš°): `ì»´í¬ë„ŒíŠ¸ëª… /ê²½ë¡œ/ê²½ë¡œ/.jsx` (ì˜ˆ: Task ì¹´ë“œ ì»´í¬ë„ŒíŠ¸ /src/components/tasks/TaskCard.jsx)
  - ì½ì€ ì»´í¬ë„ŒíŠ¸ íŒŒì¼ë“¤ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ UI ì»´í¬ë„ŒíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
  - ì˜ˆ: ChatBot ì»´í¬ë„ŒíŠ¸, TaskView ì»´í¬ë„ŒíŠ¸, ProjectCard ì»´í¬ë„ŒíŠ¸, GitHub CommitList ì»´í¬ë„ŒíŠ¸ ë“±
  - ì»´í¬ë„ŒíŠ¸ê°€ ì—†ë‹¤ë©´ ì´ ì†Œì œëª©ì„ ìƒëµí•˜ì„¸ìš”.
- **ì¸í”„ë¼**: `ê¸°ëŠ¥ëª… /ìœ„ì¹˜` (ì˜ˆ: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° /database/db.js, JWT ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ /middleware/auth.js)
  - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, ì¸ì¦ ë¯¸ë“¤ì›¨ì–´, íŒŒì¼ ì—…ë¡œë“œ, CORS ì„¤ì • ë“± ë°±ì—”ë“œ ì¸í”„ë¼ ê¸°ëŠ¥ì„ í™•ì¸í•˜ì„¸ìš”.
- **í…ŒìŠ¤íŠ¸/ë°°í¬** (í”„ë¡œì íŠ¸ íŠ¹ì„±ì— ë”°ë¼ ìˆì„ ìˆ˜ ìˆìŒ): `ê¸°ëŠ¥ëª… /ìœ„ì¹˜` (ì˜ˆ: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ /tests/unit/, CI/CD íŒŒì´í”„ë¼ì¸ /.github/workflows/ci.yml, Docker ì„¤ì • /Dockerfile)
  - í…ŒìŠ¤íŠ¸ íŒŒì¼(*.test.js, *.spec.js, __tests__/ ë“±), CI/CD ì„¤ì •(.github/workflows/, .gitlab-ci.yml ë“±), ë°°í¬ ì„¤ì •(Dockerfile, docker-compose.yml ë“±)ì„ í™•ì¸í•˜ì„¸ìš”.
  - í”„ë¡œì íŠ¸ íŠ¹ì„±ì— ë”°ë¼ í…ŒìŠ¤íŠ¸/ë°°í¬ê°€ í•„ìš” ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸ ë“±).

**íŒŒì¼ ê²€ìƒ‰ ì „ëµ:**
- ì½ì€ íŒŒì¼ì—ì„œ í˜ì´ì§€ë‚˜ ì»´í¬ë„ŒíŠ¸ê°€ ì—†ë‹¤ê³  íŒë‹¨ë˜ë©´, ë‹¤ë¥¸ UI ê´€ë ¨ íŒŒì¼ë“¤(views/, screens/, ui/ ë“±)ì„ ì°¾ì•„ë³´ì„¸ìš”.
- í”„ë¡œì íŠ¸ êµ¬ì¡°ë¥¼ íŒŒì•…í•˜ì—¬ ì ì ˆí•œ ë””ë ‰í† ë¦¬ì—ì„œ íŒŒì¼ì„ ì°¾ìœ¼ì„¸ìš”.

ì½ì€ íŒŒì¼ì—ì„œ ì‹¤ì œë¡œ í™•ì¸ëœ ê²ƒë§Œ ë‚˜ì—´í•˜ì„¸ìš”. ì¶”ì¸¡í•˜ì§€ ë§ˆì„¸ìš”.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{{
  "step": 3,
  "implementedFeatures": [
    {{
      "coreFeatureId": "core_feature_1",
      "coreFeatureName": "í•µì‹¬ ê¸°ëŠ¥ëª…",
      "name": "ê¸°ëŠ¥ëª… (APIëŠ” ê·¸ë£¹ëª…, ì˜ˆ: ì‚¬ìš©ì ì¸ì¦ API, í”„ë¡œì íŠ¸ ê´€ë¦¬ API, ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, CI/CD íŒŒì´í”„ë¼ì¸ ë“±)",
      "type": "page|api|component|infrastructure|test_deployment",
      "location": "í˜ì´ì§€: /ê²½ë¡œ/ê²½ë¡œ/.jsx ë˜ëŠ” API: /ì—”ë“œí¬ì¸íŠ¸, /ì—”ë“œí¬ì¸íŠ¸, /ì—”ë“œí¬ì¸íŠ¸ (ëª¨ë“  ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸ ë‚˜ì—´) ë˜ëŠ” ì»´í¬ë„ŒíŠ¸: /ê²½ë¡œ/ê²½ë¡œ/.jsx ë˜ëŠ” ì¸í”„ë¼: /ìœ„ì¹˜ ë˜ëŠ” í…ŒìŠ¤íŠ¸/ë°°í¬: /í…ŒìŠ¤íŠ¸_íŒŒì¼_ê²½ë¡œ ë˜ëŠ” /ë°°í¬_ì„¤ì •_íŒŒì¼",
      "filePath": "ì£¼ìš” íŒŒì¼ ê²½ë¡œ (1-2ê°œ)"
    }}
  ],
  "coreFeatureProgress": [
    {{
      "coreFeatureId": "core_feature_1",
      "coreFeatureName": "í•µì‹¬ ê¸°ëŠ¥ëª…",
      "requiredCount": 5,
      "implementedCount": 4,
      "progress": 80.0
    }}
  ],
  "nextStep": "ë‹¤ìŒ ë‹¨ê³„(4ë‹¨ê³„)ì—ì„œëŠ” ë¯¸êµ¬í˜„ ê¸°ëŠ¥ì„ ë¶„ì„í•˜ê² ìŠµë‹ˆë‹¤."
}}

âš ï¸ **ë§¤ìš° ì¤‘ìš”**: 
- **2ë‹¨ê³„ ê²€ì¦**: 2ë‹¨ê³„ì—ì„œ ì •ì˜í•œ ëª¨ë“  {len(required_features)}ê°œ ê¸°ëŠ¥ì„ í™•ì¸í–ˆëŠ”ì§€ ê²€ì¦í•˜ì„¸ìš”.
- ì½ì€ íŒŒì¼ ë‚´ìš©ì„ ë¬´ì‹œí•˜ì§€ ë§ê³ , ì‹¤ì œë¡œ íŒŒì¼ì—ì„œ í™•ì¸ëœ ê¸°ëŠ¥ë§Œ ë‚˜ì—´í•˜ì„¸ìš”.
- **ë°˜ë“œì‹œ í˜ì´ì§€, API, ì»´í¬ë„ŒíŠ¸, ì¸í”„ë¼, í…ŒìŠ¤íŠ¸/ë°°í¬ 5ê°€ì§€ ë¶„ë¥˜ë¡œ ë‚˜ëˆ„ì–´ ë‚˜ì—´í•˜ì„¸ìš”.**
- **í•µì‹¬ ê¸°ëŠ¥ ìœ„ì£¼ë¡œ í™•ì¸í•˜ì„¸ìš”**: ì‚¬ìš©ì ì¸ì¦, í”„ë¡œì íŠ¸ ê´€ë¦¬, Task ê´€ë¦¬, AI ê¸°ëŠ¥, GitHub ì—°ë™ ë“±ì€ í•µì‹¬ ê¸°ëŠ¥ì…ë‹ˆë‹¤.
- **ì¸í”„ë¼ ê¸°ëŠ¥ì€ í•µì‹¬ ê¸°ëŠ¥ì— í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.** (ë³„ë„ë¡œ ë‚˜ì—´, coreFeatureId ì—†ì´)
- **ì‚¬ì†Œí•œ ê¸°ëŠ¥ì€ ì œì™¸í•˜ì„¸ìš”**: í”„ë¡œí•„ ë³€ê²½, ì„¤ì • í˜ì´ì§€, UI ê°œì„  ë“±ì€ ì œì™¸í•˜ì„¸ìš”.
- **APIëŠ” ê°€ëŠ¥í•œ ëŒ€ë¶€ë¶„ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì•„ì„œ ë¹„ìŠ·í•œ ê²ƒë¼ë¦¬ ë¬¶ì–´ì„œ ê·¸ë£¹í™”í•˜ì„¸ìš”.**
- ì˜ˆë¥¼ ë“¤ì–´, routes/user.js íŒŒì¼ì„ ì½ì—ˆë‹¤ë©´ ê·¸ ì•ˆì˜ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì•„ì„œ "ì‚¬ìš©ì ì¸ì¦ API" ê·¸ë£¹ìœ¼ë¡œ ë¬¶ìœ¼ì„¸ìš”.
- í˜ì´ì§€ëŠ” ê²½ë¡œë§Œ, APIëŠ” ì—”ë“œí¬ì¸íŠ¸ë¥¼ í¬ê´„ì ìœ¼ë¡œ ë‚˜ì—´í•˜ì„¸ìš”.
- ì»´í¬ë„ŒíŠ¸ëŠ” ì¬ì‚¬ìš© ê°€ëŠ¥í•œ UI ì»´í¬ë„ŒíŠ¸ë§Œ ë‚˜ì—´í•˜ì„¸ìš”.
- ì¸í”„ë¼ëŠ” ë°ì´í„°ë² ì´ìŠ¤, ì¸ì¦, íŒŒì¼ ì—…ë¡œë“œ ë“± ë°±ì—”ë“œ ì¸í”„ë¼ ê¸°ëŠ¥ë§Œ ë‚˜ì—´í•˜ì„¸ìš”. (í•µì‹¬ ê¸°ëŠ¥ ì•„ë‹˜)
- **í…ŒìŠ¤íŠ¸/ë°°í¬**: í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ë‚˜ CI/CD ì„¤ì • íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”. í”„ë¡œì íŠ¸ íŠ¹ì„±ì— ë”°ë¼ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **í•µì‹¬ ê¸°ëŠ¥ë³„ ì§„í–‰ë„ ê³„ì‚° ê²€ì¦**: ê° í•µì‹¬ ê¸°ëŠ¥ì˜ requiredCountì™€ implementedCountê°€ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”.
- ì„¸ë¶€ ì„¤ëª…ì€ ìƒëµí•˜ê³  ìœ„ì¹˜ë§Œ ëª…ì‹œí•˜ì„¸ìš”."""
    
    elif step_number == 4:
        # 4ë‹¨ê³„: ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ë¶„ì„
        required_features = step2_result.get('requiredFeatures', [])
        implemented_features = step3_result.get('implementedFeatures', [])
        
        # êµ¬í˜„ëœ ê¸°ëŠ¥ ì´ë¦„ë“¤ì„ ì •í™•íˆ ì¶”ì¶œ (API ê·¸ë£¹ëª…, í˜ì´ì§€ëª… ë“±)
        implemented_names = []
        for feat in implemented_features:
            name = feat.get('name', '')
            feat_type = feat.get('type', '')
            location = feat.get('location', '')
            
            # APIì˜ ê²½ìš° ê·¸ë£¹ëª…ê³¼ ê°œë³„ ì—”ë“œí¬ì¸íŠ¸ ëª¨ë‘ í™•ì¸
            if feat_type == 'api':
                implemented_names.append(name)  # API ê·¸ë£¹ëª…
                # locationì—ì„œ ê°œë³„ ì—”ë“œí¬ì¸íŠ¸ ì¶”ì¶œ
                if location:
                    endpoints = [e.strip() for e in location.split(',')]
                    for endpoint in endpoints:
                        if endpoint.startswith('/api/'):
                            # ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ê¸°ëŠ¥ëª… ì¶”ì¶œ (ì˜ˆ: /api/project/create -> í”„ë¡œì íŠ¸ ìƒì„±)
                            parts = endpoint.replace('/api/', '').split('/')
                            if len(parts) >= 2:
                                resource = parts[0]  # project, task, user ë“±
                                action = parts[1]  # create, update, delete ë“±
                                implemented_names.append(f"{resource}_{action}")
            else:
                implemented_names.append(name)
        
        prompt = f"""ì§„í–‰ë„ ë¶„ì„ **4ë‹¨ê³„: ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ë¶„ì„**ì…ë‹ˆë‹¤.

## ì´ì „ ë‹¨ê³„ ê²°ê³¼:

### 1ë‹¨ê³„: í”„ë¡œì íŠ¸ ë¶„ì„
í”„ë¡œì íŠ¸ ì´ë¦„: {step1_result.get('projectName', 'N/A')}
í”„ë¡œì íŠ¸ ì„¤ëª…: {step1_result.get('projectDescription', 'N/A')[:200]}...

### 2ë‹¨ê³„: í•„ìš”í•œ ê¸°ëŠ¥ ë¶„ì„
í•„ìš”í•œ ê¸°ëŠ¥ ìˆ˜: {len(required_features)}ê°œ

### 3ë‹¨ê³„: êµ¬í˜„ëœ ê¸°ëŠ¥ í™•ì¸
êµ¬í˜„ëœ ê¸°ëŠ¥ ìˆ˜: {len(implemented_features)}ê°œ
êµ¬í˜„ëœ ê¸°ëŠ¥ ëª©ë¡:
{json.dumps(implemented_features, ensure_ascii=False, indent=2)[:2000]}

{files_section}

## 4ë‹¨ê³„ ì‘ì—…: ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ë¶„ì„
í•„ìš”í•œ ê¸°ëŠ¥ ëª©ë¡ê³¼ êµ¬í˜„ëœ ê¸°ëŠ¥ ëª©ë¡ì„ **ì •í™•íˆ** ë¹„êµí•˜ì—¬, ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì€ ê¸°ëŠ¥ì„ ì°¾ìœ¼ì„¸ìš”.

**âš ï¸ ë§¤ìš° ì¤‘ìš”: íŒë‹¨ ê³¼ì •ì„ ë‹¨ê³„ë³„ë¡œ ëª…í™•íˆ ìˆ˜í–‰í•˜ì„¸ìš”.**

### 0ë‹¨ê³„: ì´ì „ ë‹¨ê³„ ê²°ê³¼ ê²€ì¦
- 2ë‹¨ê³„: í•„ìš”í•œ ê¸°ëŠ¥ ìˆ˜ = {len(required_features)}ê°œ
- 3ë‹¨ê³„: êµ¬í˜„ëœ ê¸°ëŠ¥ ìˆ˜ = {len(implemented_features)}ê°œ
- **ê²€ì¦**: 2ë‹¨ê³„ì™€ 3ë‹¨ê³„ì˜ ì¹´ìš´íŠ¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

### 1ë‹¨ê³„: í•„ìš”í•œ ê¸°ëŠ¥ ëª©ë¡ í™•ì¸
- 2ë‹¨ê³„ì—ì„œ ë‚˜ì—´í•œ "í•„ìš”í•œ ê¸°ëŠ¥" ëª©ë¡ì„ **í•˜ë‚˜ì”© í™•ì¸**í•˜ì„¸ìš”.
- ê° ê¸°ëŠ¥ì´ ë¬´ì—‡ì¸ì§€ ëª…í™•íˆ ì´í•´í•˜ì„¸ìš”.
- **ì „ì²´ {len(required_features)}ê°œ ê¸°ëŠ¥ì„ ëª¨ë‘ í™•ì¸**í•´ì•¼ í•©ë‹ˆë‹¤.

### 2ë‹¨ê³„: êµ¬í˜„ ì—¬ë¶€ í™•ì¸ (ì—„ê²©í•˜ê²Œ)
- ê° "í•„ìš”í•œ ê¸°ëŠ¥"ì´ "êµ¬í˜„ëœ ê¸°ëŠ¥" ëª©ë¡ì— ìˆëŠ”ì§€ **í•˜ë‚˜ì”© í™•ì¸**í•˜ì„¸ìš”.
- **ì²´í¬ë¦¬ìŠ¤íŠ¸ ë°©ì‹ìœ¼ë¡œ í•˜ë‚˜ì”© í™•ì¸**í•˜ì„¸ìš”:
  - ê¸°ëŠ¥ëª…ì´ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ê°€?
  - APIì˜ ê²½ìš°: API ê·¸ë£¹ëª…ê³¼ ê°œë³„ ì—”ë“œí¬ì¸íŠ¸ ëª¨ë‘ í™•ì¸
  - í˜ì´ì§€/ì»´í¬ë„ŒíŠ¸ì˜ ê²½ìš°: íŒŒì¼ ê²½ë¡œ í™•ì¸
- APIì˜ ê²½ìš°:
  - API ê·¸ë£¹ëª…ì„ í™•ì¸í•˜ì„¸ìš” (ì˜ˆ: "í”„ë¡œì íŠ¸ ê´€ë¦¬ API")
  - í•´ë‹¹ ê·¸ë£¹ì˜ locationì— ê°œë³„ ì—”ë“œí¬ì¸íŠ¸ê°€ ë‚˜ì—´ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
  - ì˜ˆ: "í”„ë¡œì íŠ¸ ê´€ë¦¬ API"ì˜ locationì— /api/project/createê°€ ìˆë‹¤ë©´, "í”„ë¡œì íŠ¸ ìƒì„±" ê¸°ëŠ¥ì€ ì´ë¯¸ êµ¬í˜„ëœ ê²ƒì…ë‹ˆë‹¤.
- í˜ì´ì§€/ì»´í¬ë„ŒíŠ¸ì˜ ê²½ìš°:
  - ê¸°ëŠ¥ëª…ê³¼ íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.
  - ì½ì€ íŒŒì¼ ëª©ë¡ì— í•´ë‹¹ íŒŒì¼ì´ ìˆë‹¤ë©´ êµ¬í˜„ëœ ê²ƒì…ë‹ˆë‹¤.

### 3ë‹¨ê³„: ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ì„ ë³„
- 2ë‹¨ê³„ì—ì„œ "êµ¬í˜„ë˜ì§€ ì•ŠìŒ"ìœ¼ë¡œ í™•ì¸ëœ ê¸°ëŠ¥ë§Œ "ë¯¸êµ¬í˜„ ê¸°ëŠ¥" ëª©ë¡ì— ì¶”ê°€í•˜ì„¸ìš”.
- **ì´ë¯¸ êµ¬í˜„ëœ ê¸°ëŠ¥ì„ ë¯¸êµ¬í˜„ìœ¼ë¡œ ë¶„ë¥˜í•˜ì§€ ë§ˆì„¸ìš”.**
- ê° ë¯¸êµ¬í˜„ ê¸°ëŠ¥ì— ëŒ€í•´ ì™œ í•„ìš”í•œì§€, ì–´ë””ì— ìˆì–´ì•¼ í•˜ëŠ”ì§€ ëª…ì‹œí•˜ì„¸ìš”.

### 4ë‹¨ê³„: ì¹´ìš´íŠ¸ ê²€ì¦ (ì—„ê²©í•˜ê²Œ)
- **í•„ìˆ˜ ê²€ì¦ ê³µì‹**: í•„ìš”í•œ ê¸°ëŠ¥ ìˆ˜ ({len(required_features)}ê°œ) = êµ¬í˜„ëœ ê¸°ëŠ¥ ìˆ˜ ({len(implemented_features)}ê°œ) + ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ìˆ˜ (Xê°œ)
- **ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.** ë¶ˆì¼ì¹˜í•œë‹¤ë©´:
  1. 2ë‹¨ê³„ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.
  2. 3ë‹¨ê³„ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.
  3. ê° ê¸°ëŠ¥ì„ í•˜ë‚˜ì”© ë‹¤ì‹œ ë¹„êµí•˜ì„¸ìš”.
- ë¶ˆì¼ì¹˜ ì‹œ: ì¬í™•ì¸ í›„ ë‹¤ì‹œ ì‘ë‹µí•˜ì„¸ìš”.

**ë§¤ìš° ì¤‘ìš”:**
- êµ¬í˜„ëœ ê¸°ëŠ¥ ëª©ë¡ì„ **ìì„¸íˆ í™•ì¸**í•˜ì„¸ìš”. API ê·¸ë£¹ì— í¬í•¨ëœ ê°œë³„ ì—”ë“œí¬ì¸íŠ¸ë„ í™•ì¸í•˜ì„¸ìš”.
- ì˜ˆë¥¼ ë“¤ì–´, "í”„ë¡œì íŠ¸ ê´€ë¦¬ API"ì— /api/project/createê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´, "í”„ë¡œì íŠ¸ ìƒì„±" ê¸°ëŠ¥ì€ ì´ë¯¸ êµ¬í˜„ëœ ê²ƒì…ë‹ˆë‹¤.
- ì½ì€ íŒŒì¼ ë‚´ìš©ì„ í™•ì¸í•˜ì—¬ ì‹¤ì œë¡œ êµ¬í˜„ëœ ê¸°ëŠ¥ì¸ì§€ ê²€ì¦í•˜ì„¸ìš”.
- **ì´ë¯¸ êµ¬í˜„ëœ ê¸°ëŠ¥ì„ ë¯¸êµ¬í˜„ìœ¼ë¡œ ë¶„ë¥˜í•˜ì§€ ë§ˆì„¸ìš”.**

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{{
  "step": 4,
  "missingFeatures": [
    {{
      "name": "ê¸°ëŠ¥ëª…",
      "reason": "ì™œ í•„ìš”í•œì§€",
      "expectedLocation": "ì˜ˆìƒ íŒŒì¼ ìœ„ì¹˜"
    }}
  ],
  "nextStep": "ë‹¤ìŒ ë‹¨ê³„(5ë‹¨ê³„)ì—ì„œëŠ” í‰ê°€ ë° ì§„í–‰ë„ ê³„ì‚°ì„ ìˆ˜í–‰í•˜ê² ìŠµë‹ˆë‹¤."
}}

âš ï¸ **ë§¤ìš° ì¤‘ìš”**: 
- í•„ìš”í•œ ê¸°ëŠ¥ ì¤‘ **ì •ë§ë¡œ** êµ¬í˜„ëœ ê¸°ëŠ¥ì— ì—†ëŠ” ê²ƒë§Œ ë‚˜ì—´í•˜ì„¸ìš”.
- êµ¬í˜„ëœ ê¸°ëŠ¥ ëª©ë¡ì„ ìì„¸íˆ í™•ì¸í•˜ì—¬ ì¤‘ë³µ ë¶„ë¥˜ë¥¼ í”¼í•˜ì„¸ìš”.
- ê° ë¯¸êµ¬í˜„ ê¸°ëŠ¥ì— ëŒ€í•´ ì™œ í•„ìš”í•œì§€, ì–´ë””ì— ìˆì–´ì•¼ í•˜ëŠ”ì§€ ëª…ì‹œí•˜ì„¸ìš”."""
    
    else:
        # 5ë‹¨ê³„ ì´ìƒ: í‰ê°€ ë° ì§„í–‰ë„ ê³„ì‚°
        required_features = step2_result.get('requiredFeatures', [])
        implemented_features = step3_result.get('implementedFeatures', [])
        missing_features = step4_result.get('missingFeatures', []) if len(all_steps) > 3 else []
        
        project_name = step1_result.get('projectName', 'í”„ë¡œì íŠ¸')
        project_desc = step1_result.get('projectDescription', '')
        
        # ì§„í–‰ë„ ê³„ì‚°
        total_required = len(required_features)
        total_implemented = len(implemented_features)
        total_missing = len(missing_features)
        progress = round((total_implemented / total_required * 100) if total_required > 0 else 0, 1)
        
        # êµ¬í˜„ëœ ê¸°ëŠ¥ ëª©ë¡ ìƒì„± (ê°„ë‹¨í•˜ê²Œ)
        implemented_list = []
        for feat in implemented_features:
            name = feat.get('name', '')
            feat_type = feat.get('type', 'other')
            location = feat.get('location', feat.get('filePath', ''))
            if feat_type == 'page':
                implemented_list.append(f"- **{name}** {location}")
            elif feat_type == 'api':
                implemented_list.append(f"- **{name}** {location}")
            else:
                implemented_list.append(f"- **{name}** {location}")
        
        # ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ëª©ë¡ ìƒì„± (ê°„ë‹¨í•˜ê²Œ)
        missing_list = []
        for feat in missing_features:
            name = feat.get('name', '')
            expected_loc = feat.get('expectedLocation', '')
            missing_list.append(f"- **{name}**: {expected_loc}")
        
        prompt = f"""ì§„í–‰ë„ ë¶„ì„ **5ë‹¨ê³„: í‰ê°€ ë° ì§„í–‰ë„ ê³„ì‚°**ì…ë‹ˆë‹¤.

## ì´ì „ ë‹¨ê³„ ê²°ê³¼ ìš”ì•½:

### 1ë‹¨ê³„: í”„ë¡œì íŠ¸ ë¶„ì„
í”„ë¡œì íŠ¸ ì´ë¦„: {project_name}
í”„ë¡œì íŠ¸ ì„¤ëª…: {project_desc[:200]}...

### 2ë‹¨ê³„: í•„ìš”í•œ ê¸°ëŠ¥ ë¶„ì„
í•„ìš”í•œ ê¸°ëŠ¥ ëª©ë¡:
{json.dumps(required_features, ensure_ascii=False, indent=2)[:1500]}
**ì´ í•„ìš”í•œ ê¸°ëŠ¥ ìˆ˜: {total_required}ê°œ**

### 3ë‹¨ê³„: êµ¬í˜„ëœ ê¸°ëŠ¥ í™•ì¸
êµ¬í˜„ëœ ê¸°ëŠ¥ ëª©ë¡:
{json.dumps(implemented_features, ensure_ascii=False, indent=2)[:2000]}
**ì´ êµ¬í˜„ëœ ê¸°ëŠ¥ ìˆ˜: {total_implemented}ê°œ**

### 4ë‹¨ê³„: ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ë¶„ì„
ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ëª©ë¡:
{json.dumps(missing_features, ensure_ascii=False, indent=2)[:1000]}
**ì´ ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ìˆ˜: {total_missing}ê°œ**

## 5ë‹¨ê³„ ì‘ì—…: ì •í™•í•œ í‰ê°€ ë° ì§„í–‰ë„ ê³„ì‚°

**âš ï¸ ë§¤ìš° ì¤‘ìš”: íŒë‹¨ ê³¼ì •ì„ ë‹¨ê³„ë³„ë¡œ ëª…í™•íˆ ìˆ˜í–‰í•˜ì„¸ìš”.**

### 0ë‹¨ê³„: ëª¨ë“  ë‹¨ê³„ ê²°ê³¼ ê²€ì¦
- **1ë‹¨ê³„ ê²€ì¦**: í•µì‹¬ ê¸°ëŠ¥ì´ 3-6ê°œì´ê³ , ì¸í”„ë¼ê°€ í¬í•¨ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
- **2ë‹¨ê³„ ê²€ì¦**: ê° í•µì‹¬ ê¸°ëŠ¥ë‹¹ 3-8ê°œì˜ ì„¸ë¶€ ê¸°ëŠ¥ì´ ìˆëŠ”ì§€ í™•ì¸
- **3ë‹¨ê³„ ê²€ì¦**: í•µì‹¬ ê¸°ëŠ¥ë³„ ì§„í–‰ë„ê°€ ê³„ì‚°ë˜ì—ˆëŠ”ì§€ í™•ì¸
- **4ë‹¨ê³„ ê²€ì¦**: í•„ìš”í•œ ê¸°ëŠ¥ ìˆ˜ = êµ¬í˜„ëœ ê¸°ëŠ¥ ìˆ˜ + ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ìˆ˜ (ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨)

### 1ë‹¨ê³„: ê¸°ëŠ¥ ì¹´ìš´íŠ¸ ìµœì¢… ê²€ì¦ (ì—„ê²©í•˜ê²Œ)
- í•„ìš”í•œ ê¸°ëŠ¥ ìˆ˜: {total_required}ê°œ
- êµ¬í˜„ëœ ê¸°ëŠ¥ ìˆ˜: {total_implemented}ê°œ
- ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ìˆ˜: {total_missing}ê°œ
- **í•„ìˆ˜ ê²€ì¦ ê³µì‹**: {total_required} = {total_implemented} + {total_missing}
- **ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.** ë¶ˆì¼ì¹˜í•œë‹¤ë©´:
  1. 2ë‹¨ê³„ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.
  2. 3ë‹¨ê³„ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.
  3. 4ë‹¨ê³„ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.
  4. ê° ê¸°ëŠ¥ì„ í•˜ë‚˜ì”© ë‹¤ì‹œ ë¹„êµí•˜ì„¸ìš”.
- ë¶ˆì¼ì¹˜ ì‹œ: ì¬í™•ì¸ í›„ ë‹¤ì‹œ ì‘ë‹µí•˜ì„¸ìš”.

### 2ë‹¨ê³„: êµ¬í˜„ ì—¬ë¶€ ì¬í™•ì¸ (ì´ì¤‘ í™•ì¸)
- ê° "í•„ìš”í•œ ê¸°ëŠ¥"ì´ "êµ¬í˜„ëœ ê¸°ëŠ¥" ëª©ë¡ì— ìˆëŠ”ì§€ **í•˜ë‚˜ì”© í™•ì¸**í•˜ì„¸ìš”.
- APIì˜ ê²½ìš°, API ê·¸ë£¹ëª…ë¿ë§Œ ì•„ë‹ˆë¼ ê°œë³„ ì—”ë“œí¬ì¸íŠ¸ë„ í™•ì¸í•˜ì„¸ìš”.
- ì˜ˆ: "í”„ë¡œì íŠ¸ ìƒì„±" ê¸°ëŠ¥ì´ í•„ìš”í•˜ë‹¤ë©´, "í”„ë¡œì íŠ¸ ê´€ë¦¬ API"ì— /api/project/createê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
- ì½ì€ íŒŒì¼ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì‹¤ì œë¡œ êµ¬í˜„ë˜ì–´ ìˆëŠ”ì§€ ê²€ì¦í•˜ì„¸ìš”.
- **ì´ë¯¸ êµ¬í˜„ëœ ê¸°ëŠ¥ì„ ë¯¸êµ¬í˜„ìœ¼ë¡œ ë¶„ë¥˜í•˜ì§€ ë§ˆì„¸ìš”.**

### 3ë‹¨ê³„: í…ŒìŠ¤íŠ¸/ë°°í¬ ë¹„ìœ¨ ê²°ì •
- í”„ë¡œì íŠ¸ íŠ¹ì„±ì„ ê³ ë ¤í•˜ì—¬ í…ŒìŠ¤íŠ¸/ë°°í¬ê°€ í•„ìš”í•œì§€ íŒë‹¨í•˜ì„¸ìš”.
- **ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë‚˜ API ì„œë²„**: í…ŒìŠ¤íŠ¸/ë°°í¬ ë¹„ìœ¨ 10~20% ê¶Œì¥
- **ë¼ì´ë¸ŒëŸ¬ë¦¬**: í…ŒìŠ¤íŠ¸ ë¹„ìœ¨ 10~15% ê¶Œì¥
- **ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸ë‚˜ ë„êµ¬**: í…ŒìŠ¤íŠ¸/ë°°í¬ ë¹„ìœ¨ 0~5%
- **í”„ë¡œë•ì…˜ ìˆ˜ì¤€ì˜ í”„ë¡œì íŠ¸**: í…ŒìŠ¤íŠ¸/ë°°í¬ ë¹„ìœ¨ 15~20%
- **í”„ë¡œí† íƒ€ì…ì´ë‚˜ MVP**: í…ŒìŠ¤íŠ¸/ë°°í¬ ë¹„ìœ¨ 5~10%
- í…ŒìŠ¤íŠ¸/ë°°í¬ ê¸°ëŠ¥ì´ í•„ìš”í•œ ê¸°ëŠ¥ ëª©ë¡ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
- í…ŒìŠ¤íŠ¸/ë°°í¬ ê¸°ëŠ¥ì´ ì—†ë‹¤ë©´ ë¹„ìœ¨ì„ 0%ë¡œ ì„¤ì •í•˜ì„¸ìš”.

### 4ë‹¨ê³„: ê¸°ë³¸ ì§„í–‰ë„ ê³„ì‚°
- **ê¸°ë³¸ ê³„ì‚°ì‹**: (êµ¬í˜„ëœ ê¸°ëŠ¥ ìˆ˜ / í•„ìš”í•œ ê¸°ëŠ¥ ìˆ˜) Ã— 100
- ê³„ì‚°: ({total_implemented} / {total_required}) Ã— 100 = {progress}%
- ì´ ê°’ì€ ê¸°ëŠ¥ êµ¬í˜„ ì§„í–‰ë„ì…ë‹ˆë‹¤.

### 5ë‹¨ê³„: í…ŒìŠ¤íŠ¸/ë°°í¬ ì§„í–‰ë„ ê³„ì‚° ë° ìµœì¢… ì§„í–‰ë„ ì‚°ì¶œ
- í…ŒìŠ¤íŠ¸/ë°°í¬ ê´€ë ¨ ê¸°ëŠ¥ì´ ìˆëŠ” ê²½ìš°:
  - í…ŒìŠ¤íŠ¸/ë°°í¬ í•„ìš”í•œ ê¸°ëŠ¥ ìˆ˜: requiredFeaturesì—ì„œ typeì´ "test_deployment"ì¸ ê¸°ëŠ¥ ìˆ˜
  - í…ŒìŠ¤íŠ¸/ë°°í¬ êµ¬í˜„ëœ ê¸°ëŠ¥ ìˆ˜: implementedFeaturesì—ì„œ typeì´ "test_deployment"ì¸ ê¸°ëŠ¥ ìˆ˜
  - í…ŒìŠ¤íŠ¸/ë°°í¬ ì§„í–‰ë„ = (êµ¬í˜„ëœ í…ŒìŠ¤íŠ¸/ë°°í¬ ê¸°ëŠ¥ ìˆ˜ / í•„ìš”í•œ í…ŒìŠ¤íŠ¸/ë°°í¬ ê¸°ëŠ¥ ìˆ˜) Ã— 100
  - í…ŒìŠ¤íŠ¸/ë°°í¬ ë¹„ìœ¨: í”„ë¡œì íŠ¸ íŠ¹ì„±ì— ë”°ë¼ 0~20% (ìœ„ 3ë‹¨ê³„ì—ì„œ ê²°ì •)
  - **ìµœì¢… ì§„í–‰ë„ ê³„ì‚°**: ê¸°ë³¸ ì§„í–‰ë„ Ã— (1 - í…ŒìŠ¤íŠ¸/ë°°í¬_ë¹„ìœ¨) + í…ŒìŠ¤íŠ¸/ë°°í¬_ì§„í–‰ë„ Ã— í…ŒìŠ¤íŠ¸/ë°°í¬_ë¹„ìœ¨
  - ì˜ˆ: ê¸°ë³¸ ì§„í–‰ë„ 80%, í…ŒìŠ¤íŠ¸/ë°°í¬ ë¹„ìœ¨ 15%, í…ŒìŠ¤íŠ¸/ë°°í¬ ì§„í–‰ë„ 50% â†’ ìµœì¢… ì§„í–‰ë„ = 80% Ã— 0.85 + 50% Ã— 0.15 = 75.5%
- í…ŒìŠ¤íŠ¸/ë°°í¬ ê´€ë ¨ ê¸°ëŠ¥ì´ ì—†ëŠ” ê²½ìš°:
  - í…ŒìŠ¤íŠ¸/ë°°í¬ ë¹„ìœ¨ = 0%
  - ìµœì¢… ì§„í–‰ë„ = ê¸°ë³¸ ì§„í–‰ë„

### 6ë‹¨ê³„: ê°€ì¤‘ì¹˜ ì ìš© (ì„ íƒì‚¬í•­)
- í•µì‹¬ ê¸°ëŠ¥ê³¼ ì‚¬ì†Œí•œ ê¸°ëŠ¥ì„ êµ¬ë¶„í•˜ì—¬ ê°€ì¤‘ì¹˜ë¥¼ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- í•˜ì§€ë§Œ ê¸°ë³¸ ì§„í–‰ë„ëŠ” ìœ„ ê³„ì‚°ì‹ì— ë”°ë¦…ë‹ˆë‹¤.

**ì¤‘ìš” ì²´í¬ì‚¬í•­:**
- êµ¬í˜„ëœ APIê°€ í•„ìš”í•œ ëª¨ë“  APIë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
- ì½ì€ íŒŒì¼ì—ì„œ í™•ì¸ëœ API ì—”ë“œí¬ì¸íŠ¸ê°€ í•„ìš”í•œ ê¸°ëŠ¥ ëª©ë¡ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦í•˜ì„¸ìš”.
- ëˆ„ë½ëœ APIê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{{
  "step": 5,
  "currentProgress": {progress},
  "completedFeaturesCount": {total_implemented},
  "requiredFeaturesCount": {total_required},
  "missingFeaturesCount": {total_missing},
  "narrativeResponse": "[í”„ë¡œì íŠ¸ ì„¤ëª…]\\n\\n### êµ¬í˜„ëœ ê¸°ëŠ¥\\n[êµ¬í˜„ëœ ê¸°ëŠ¥ ëª©ë¡]\\n\\n### ë¯¸êµ¬í˜„ ê¸°ëŠ¥\\n[ë¯¸êµ¬í˜„ ê¸°ëŠ¥ ëª©ë¡]\\n\\n### í‰ê°€\\n[í•µì‹¬ ê¸°ëŠ¥ë³„ ì§„í–‰ë„ í‘œì‹œ ë˜ëŠ” ì „ì²´ ì§„í–‰ë„]\\n\\nì „ì²´ ì§„í–‰ë„: {progress}% (ì™„ì„±ëœ ê¸°ëŠ¥ {total_implemented}ê°œ, êµ¬í˜„í•´ì•¼ í•  ê¸°ëŠ¥ {total_missing}ê°œ)\\n\\n**ì˜ˆìƒ ì™„ì„±ì¼**: [í˜„ì¬ ì§„í–‰ ì†ë„ë¥¼ ê³ ë ¤í•œ ì˜ˆìƒ ì™„ì„±ì¼ ë˜ëŠ” 'ë¯¸ì •']\\n\\n**ì´í‰**: [í”„ë¡œì íŠ¸ì˜ í˜„ì¬ ìƒíƒœë¥¼ 2-3ì¤„ë¡œ ìš”ì•½í•œ ì´í‰. í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„ ìƒíƒœ, ì£¼ìš” ë¯¸êµ¬í˜„ ê¸°ëŠ¥, ì „ì²´ì ì¸ í”„ë¡œì íŠ¸ ìƒíƒœë¥¼ ê°„ê²°í•˜ê²Œ ì„¤ëª…]",
  "activityTrend": "increasing|stable|decreasing",
  "delayRisk": "Low|Medium|High",
  "estimatedCompletionDate": "YYYY-MM-DD ë˜ëŠ” null",
  "insights": ["ì¸ì‚¬ì´íŠ¸ 1", "ì¸ì‚¬ì´íŠ¸ 2", "ì¸ì‚¬ì´íŠ¸ 3"],
  "recommendations": ["ì œì•ˆ 1", "ì œì•ˆ 2", "ì œì•ˆ 3"]
}}

âš ï¸ **ë§¤ìš° ì¤‘ìš”**: 
- narrativeResponseì˜ í‰ê°€ ì„¹ì…˜ì€ ë°˜ë“œì‹œ "ì™„ì„±ëœ ê¸°ëŠ¥ {total_implemented}ê°œ, êµ¬í˜„í•´ì•¼ í•  ê¸°ëŠ¥ {total_missing}ê°œë¡œ ì§„í–‰ë„ {progress}%ì…ë‹ˆë‹¤." í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
- currentProgressëŠ” ë°˜ë“œì‹œ {progress}ì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤ (ê³„ì‚°: {total_implemented}/{total_required}Ã—100).
- completedFeaturesCount, requiredFeaturesCount, missingFeaturesCountë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.
- ì´í‰ì€ 2-3ì¤„ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
- API ì™„ì „ì„±ì„ ì²´í¬í•˜ì—¬ ëˆ„ë½ëœ APIê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."""
    
    return prompt

def create_task_completion_initial_prompt(context, user_message, read_files, analyzed_commits):
    """Task ì™„ë£Œ í™•ì¸ ì—ì´ì „íŠ¸ ì´ˆê¸° í”„ë¡¬í”„íŠ¸"""
    task = context.get('task')
    commits = context.get('commits', [])
    projectDescription = context.get('projectDescription', '')
    
    if not task:
        return "Task ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤."
    
    return create_initial_completion_prompt(task, commits, projectDescription)

def create_task_completion_followup_prompt(context, previous_result, user_message, read_files, analyzed_commits):
    """Task ì™„ë£Œ í™•ì¸ ì—ì´ì „íŠ¸ í›„ì† í”„ë¡¬í”„íŠ¸"""
    task = context.get('task')
    commits = context.get('commits', [])
    projectDescription = context.get('projectDescription', '')
    
    if not task:
        return "Task ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤."
    
    # ì½ì€ íŒŒì¼ ì •ë³´ ì¶”ê°€
    files_context = ""
    if read_files:
        files_context = "\n\n## ì½ì€ íŒŒì¼ ë‚´ìš©:\n"
        for file_info in read_files:
            content = file_info.get('content', '')[:1000]  # ìµœëŒ€ 1000ì
            files_context += f"íŒŒì¼: {file_info.get('path', '')}\n{content}\n---\n"
    
    base_prompt = create_followup_completion_prompt(task, previous_result, commits, projectDescription)
    
    return base_prompt + files_context + "\n\nìœ„ íŒŒì¼ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ìµœì¢… íŒë‹¨í•˜ì„¸ìš”."

def create_general_qa_initial_prompt(context, user_message, read_files, analyzed_commits):
    """ì¼ë°˜ QA ì—ì´ì „íŠ¸ ì´ˆê¸° í”„ë¡¬í”„íŠ¸"""
    commits = context.get('commits', [])
    issues = context.get('issues', [])
    tasks = context.get('tasks', [])
    projectDescription = context.get('projectDescription', '')
    githubRepo = context.get('githubRepo', '')
    
    # í”„ë¡œì íŠ¸ í†µê³„ ê³„ì‚°
    task_stats = {
        'total': len(tasks),
        'todo': sum(1 for t in tasks if t.get('status') == 'todo'),
        'in_progress': sum(1 for t in tasks if t.get('status') == 'in_progress'),
        'done': sum(1 for t in tasks if t.get('status') == 'done')
    }
    
    commit_stats = {
        'total': len(commits),
        'total_lines_added': sum(c.get('linesAdded', 0) or 0 for c in commits),
        'total_lines_deleted': sum(c.get('linesDeleted', 0) or 0 for c in commits),
        'total_files_changed': sum(c.get('filesChanged', 0) or 0 for c in commits)
    }
    
    issue_stats = {
        'total': len(issues),
        'open': sum(1 for i in issues if i.get('state') == 'open'),
        'closed': sum(1 for i in issues if i.get('state') == 'closed')
    }
    
    from datetime import datetime, timedelta, timezone
    now = datetime.now(timezone.utc)
    week_ago = now - timedelta(days=7)
    recent_commits = sum(1 for c in commits if c.get('date') and 
                        datetime.fromisoformat(c.get('date').replace('Z', '+00:00')) >= week_ago)
    
    # ìµœê·¼ ì»¤ë°‹ ìƒì„¸ ì •ë³´
    recent_commits_detail = []
    for commit in commits[:10]:
        recent_commits_detail.append({
            "message": commit.get('message', '')[:150],
            "date": commit.get('date', ''),
            "author": commit.get('author', ''),
            "linesAdded": commit.get('linesAdded', 0),
            "linesDeleted": commit.get('linesDeleted', 0)
        })
    
    # ìµœê·¼ Task ìƒì„¸ ì •ë³´
    recent_tasks_detail = []
    for task in tasks[:10]:
        recent_tasks_detail.append({
            "title": task.get('title', ''),
            "status": task.get('status', 'todo'),
            "description": task.get('description', '')[:200],
            "dueDate": task.get('dueDate', ''),
            "assignedUserId": task.get('assignedUserId', '')
        })
    
    prompt = f"""ë‹¹ì‹ ì€ í”„ë¡œì íŠ¸ ê´€ë¦¬ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ **êµ¬ì²´ì ì´ê³  ìƒì„¸í•˜ë©° ì¹œì ˆí•˜ê²Œ** ë‹µë³€í•˜ì„¸ìš”.

âš ï¸ ì¤‘ìš”: ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì‘ë‹µí•˜ê³ , JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.

## ì‚¬ìš©ì ì§ˆë¬¸
"{user_message}"

## í”„ë¡œì íŠ¸ ì •ë³´
- í”„ë¡œì íŠ¸ ì„¤ëª…: {projectDescription[:500] if projectDescription else 'ì„¤ëª… ì—†ìŒ'}
- GitHub ì €ì¥ì†Œ: {githubRepo if githubRepo else 'ì—°ê²°ë˜ì§€ ì•ŠìŒ'}

## í”„ë¡œì íŠ¸ í†µê³„
**Task (ì‘ì—…)**
- ì „ì²´: {task_stats['total']}ê°œ
- ëŒ€ê¸° ì¤‘: {task_stats['todo']}ê°œ ({task_stats['todo']/task_stats['total']*100 if task_stats['total'] > 0 else 0:.1f}%)
- ì§„í–‰ ì¤‘: {task_stats['in_progress']}ê°œ ({task_stats['in_progress']/task_stats['total']*100 if task_stats['total'] > 0 else 0:.1f}%)
- ì™„ë£Œ: {task_stats['done']}ê°œ ({task_stats['done']/task_stats['total']*100 if task_stats['total'] > 0 else 0:.1f}%)

**ì»¤ë°‹**
- ì „ì²´: {commit_stats['total']}ê°œ
- ì¶”ê°€ëœ ë¼ì¸: {commit_stats['total_lines_added']:,}ì¤„
- ì‚­ì œëœ ë¼ì¸: {commit_stats['total_lines_deleted']:,}ì¤„
- ë³€ê²½ëœ íŒŒì¼: {commit_stats['total_files_changed']}ê°œ
- ìµœê·¼ 7ì¼ ì»¤ë°‹: {recent_commits}ê°œ

**ì´ìŠˆ**
- ì „ì²´: {issue_stats['total']}ê°œ
- ì—´ë¦¼: {issue_stats['open']}ê°œ
- ë‹«í˜: {issue_stats['closed']}ê°œ

## ìµœê·¼ ì»¤ë°‹ ìƒì„¸ (ìµœê·¼ {len(recent_commits_detail)}ê°œ)
{json.dumps(recent_commits_detail, ensure_ascii=False, indent=2)[:2000]}

## ìµœê·¼ Task ìƒì„¸ (ìµœê·¼ {len(recent_tasks_detail)}ê°œ)
{json.dumps(recent_tasks_detail, ensure_ascii=False, indent=2)[:2000]}

## ë‹µë³€ ê·œì¹™
1. ì œê³µëœ í”„ë¡œì íŠ¸ ì •ë³´ì™€ í†µê³„ë¥¼ í™œìš©í•˜ì—¬ ì‚¬ìš©ì ì§ˆë¬¸ì— **êµ¬ì²´ì ì´ê³  ìƒì„¸í•˜ê²Œ** ë‹µë³€í•˜ì„¸ìš”.
2. ì§ˆë¬¸ì´ í”„ë¡œì íŠ¸ì™€ ê´€ë ¨ì´ ìˆê³  ìœ„ ì •ë³´ë¡œ ë‹µë³€í•  ìˆ˜ ìˆë‹¤ë©´, ì¹œì ˆí•˜ê³  **ìì„¸í•˜ë©° ìœ ìš©í•œ** ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”.
3. ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ í•  ìˆ˜ ì—†ëŠ” ê²½ìš° (ì˜ˆ: í”„ë¡œì íŠ¸ì™€ ë¬´ê´€í•œ ì§ˆë¬¸, ê°œì¸ì •ë³´, ì™¸ë¶€ ì •ë³´ ë“±), ì •ì¤‘í•˜ê²Œ ê±°ë¶€í•˜ì„¸ìš”.
4. í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì¼ë°˜ì ì¸ ì§ˆë¬¸(ì„¤ëª…, í†µê³„, ìƒíƒœ, ì»¤ë°‹ ìˆ˜, ì‘ì—… ìˆ˜ ë“±)ì€ ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ **êµ¬ì²´ì ì¸ ìˆ«ìì™€ ì˜ˆì‹œë¥¼ í¬í•¨í•˜ì—¬** ë‹µë³€í•˜ì„¸ìš”.
5. ë‹µë³€ì€ ì¹œì ˆí•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.
6. ìˆ«ìëŠ” ì‰¼í‘œë¥¼ ì‚¬ìš©í•˜ì—¬ ì½ê¸° ì‰½ê²Œ í‘œì‹œí•˜ì„¸ìš”.
7. ê°€ëŠ¥í•œ í•œ **êµ¬ì²´ì ì´ê³  ìƒì„¸í•˜ë©° ìœ ìš©í•œ ì •ë³´**ë¥¼ ì œê³µí•˜ì„¸ìš”.
8. ê´€ë ¨ í†µê³„, ì˜ˆì‹œ, ì¶”ì„¸ ë“±ì„ í¬í•¨í•˜ì—¬ ë‹µë³€ì„ í’ë¶€í•˜ê²Œ ë§Œë“œì„¸ìš”.

## ì‘ë‹µ í˜•ì‹
ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš” (ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ):
{{
  "can_answer": true ë˜ëŠ” false,
  "message": "ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€í•œ **êµ¬ì²´ì ì´ê³  ìƒì„¸í•œ** ë‹µë³€ì„ í•œêµ­ì–´ë¡œ ì‘ì„± (ì¹œì ˆí•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ, ìµœì†Œ 3-5ë¬¸ì¥ ì´ìƒ)",
  "details": {{
    "used_statistics": ["ì‚¬ìš©í•œ í†µê³„ ì •ë³´ 1", "ì‚¬ìš©í•œ í†µê³„ ì •ë³´ 2"],
    "source": "ì •ë³´ ì¶œì²˜ (ì˜ˆ: 'í”„ë¡œì íŠ¸ í†µê³„', 'ì»¤ë°‹ ë°ì´í„°')",
    "examples": ["ê´€ë ¨ ì˜ˆì‹œ 1", "ê´€ë ¨ ì˜ˆì‹œ 2"]
  }},
  "sources": ["ì •ë³´ ì¶œì²˜ 1", "ì •ë³´ ì¶œì²˜ 2"],
  "relatedInfo": {{
    "keyMetric": "ì£¼ìš” ì§€í‘œ",
    "trend": "ì¶”ì„¸ ì„¤ëª…"
  }}
}}

ë§Œì•½ ë‹µë³€í•  ìˆ˜ ì—†ëŠ” ì§ˆë¬¸ì¸ ê²½ìš°:
{{
  "can_answer": false,
  "message": "ì •ì¤‘í•œ ê±°ë¶€ ë©”ì‹œì§€ë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±",
  "suggestion": "ëŒ€ì‹  ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ ì œì•ˆ"
}}"""
    
    return prompt

def create_general_qa_followup_prompt(context, previous_result, user_message, read_files, analyzed_commits):
    """ì¼ë°˜ QA ì—ì´ì „íŠ¸ í›„ì† í”„ë¡¬í”„íŠ¸"""
    prompt = f"""ì´ì „ ë‹µë³€ì„ ë³´ì™„í•˜ì—¬ ë” ì •í™•í•˜ê³  ìƒì„¸í•œ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”.

## ì‚¬ìš©ì ì§ˆë¬¸
"{user_message}"

## ì´ì „ ë‹µë³€:
{json.dumps(previous_result, ensure_ascii=False, indent=2)[:1000]}

## ì½ì€ íŒŒì¼:
{json.dumps([f.get('path', '') for f in read_files], ensure_ascii=False)[:500]}

ìœ„ íŒŒì¼ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ë” ì •í™•í•˜ê³  êµ¬ì²´ì ì¸ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”. JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”."""
    return prompt

def create_task_assignment_initial_prompt(context, user_message, read_files, analyzed_commits):
    """Task í• ë‹¹ ì¶”ì²œ ì—ì´ì „íŠ¸ ì´ˆê¸° í”„ë¡¬í”„íŠ¸"""
    task_title = context.get('taskTitle', '')
    task_description = context.get('taskDescription', '')
    project_members_with_tags = context.get('projectMembersWithTags', [])
    
    return create_task_assignment_prompt(task_title, task_description, project_members_with_tags)

def create_task_assignment_followup_prompt(context, previous_result, user_message, read_files, analyzed_commits):
    """Task í• ë‹¹ ì¶”ì²œ ì—ì´ì „íŠ¸ í›„ì† í”„ë¡¬í”„íŠ¸"""
    task_title = context.get('taskTitle', '')
    task_description = context.get('taskDescription', '')
    project_members_with_tags = context.get('projectMembersWithTags', [])
    
    prompt = f"""ì´ì „ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë” ì •í™•í•œ Task í• ë‹¹ ì¶”ì²œì„ ìˆ˜í–‰í•˜ì„¸ìš”.

## Task ì •ë³´:
ì œëª©: {task_title}
ì„¤ëª…: {task_description}

## ì´ì „ ë¶„ì„ ê²°ê³¼:
{json.dumps(previous_result, ensure_ascii=False, indent=2)[:1000]}

## ì½ì€ íŒŒì¼:
{json.dumps([f.get('path', '') for f in read_files], ensure_ascii=False)[:500]}

ìœ„ íŒŒì¼ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ Taskì— í•„ìš”í•œ ê¸°ìˆ  ìŠ¤íƒê³¼ ê²½í—˜ì„ ë” ì •í™•íˆ íŒŒì•…í•˜ê³ , ì í•©í•œ ë‹´ë‹¹ìë¥¼ ì¶”ì²œí•˜ì„¸ìš”. JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”."""
    return prompt

